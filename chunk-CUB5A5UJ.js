import{B as j,C as n,o as x,q as p,r as T,s as l,t as U,u as S,v as h,w as y,x as g,z as a}from"./chunk-MU56VQVL.js";import{a as A,i as P,k as F,l as C,p as B,r as O}from"./chunk-IK3SDQQI.js";import{a as q,b,g as f}from"./chunk-OLRFWS6T.js";var L=(()=>{let m=class m{constructor(t){this.firestore=t}getUpdatesCollection(){return l(this.firestore,"update")}getProjectsCollection(){return l(this.firestore,"projects")}getProjectDocRefByPId(t){return f(this,null,function*(){let e=a(this.getProjectsCollection(),n("p_id","==",t)),r=(yield g(e)).docs[0];return r?S(this.getProjectsCollection(),r.id):null})}getUpdateApp(){let t=this.getUpdatesCollection(),e=a(t,n("status","==",1));return p(e,{idField:"docId"}).pipe(F(o=>o[0]))}addProject(t){let e=this.getProjectsCollection();return T(e,t)}getProjectsForOwner(t){let e=l(this.firestore,"projects"),o=a(e,n("ownerId","==",t));return p(o,{idField:"docId"})}getProjectsForTeam(t){let e=l(this.firestore,"projects"),o=a(e,n("ownerId","!=",t),n("memberIds","array-contains",t));return p(o,{idField:"docId"})}getProjectsForOwnerNMember(t){let e=this.getProjectsCollection(),o=a(e,n("ownerId","==",t)),r=p(o,{idField:"docId"}),s=a(e,n("memberIds","array-contains",t)),d=p(s,{idField:"docId"});return C([r,d]).pipe(F(([i,c])=>[...i,...c].filter((w,R,$)=>$.findIndex(E=>E.docId===w.docId)===R)))}getProjectById(t){let e=l(this.firestore,"projects"),o=a(e,n("p_id","==",t));return new A(r=>{g(o).then(s=>{if(s.empty)r.next(void 0);else{let i=s.docs[0].data();r.next(i)}r.complete()}).catch(s=>{r.error(s)})})}updateProjectStatus(t,e){return f(this,null,function*(){let o=yield this.getProjectDocRefByPId(t);o&&(yield j(o,{status:e,updatedAt:new Date().toISOString().slice(0,19)}))})}updateStepStatus(t,e,o){return f(this,null,function*(){let r=yield this.getProjectDocRefByPId(t);if(!r)return;let d=(yield y(r)).data();if(d){let i=d.steps.map(c=>c.s_id===e?b(q({},c),{status:o}):c);yield j(r,{steps:i,updatedAt:new Date().toISOString().slice(0,19)})}})}addTeamMate(t,e,o,r){return f(this,null,function*(){let s=yield this.getProjectDocRefByPId(t);if(!s||e.some(R=>R.t_m_id===o))return null;let i={t_m_id:o,role:r,name:"",avatarUrl:""},c=[...e,i],I=(yield y(s)).data(),w=Array.isArray(I.memberIds)?[...I.memberIds]:[];return w.includes(o)||w.push(o),yield j(s,{team:c,memberIds:w,updatedAt:new Date().toISOString().slice(0,19)}),c})}delTeamMate(t,e,o){return f(this,null,function*(){let r=yield this.getProjectDocRefByPId(t);if(!r)return null;let s=e.filter(u=>u.t_m_id!==o),i=(yield y(r)).data(),c=Array.isArray(i.memberIds)?i.memberIds.filter(u=>u!==o):[];return yield j(r,{team:s,memberIds:c,updatedAt:new Date().toISOString().slice(0,19)}),s})}deleteProjectByPId(t){return f(this,null,function*(){try{let e=yield this.getProjectDocRefByPId(t);e&&(yield U(e),console.log(`Projet ${t} supprim\xE9 de la base`));let o=l(this.firestore,"folders"),r=a(o,n("projects","array-contains",t)),s=yield g(r);for(let d of s.docs){let i=d.data(),c=(i.projects||[]).filter(u=>u!==t);yield j(d.ref,{projects:c,updatedAt:new Date().toISOString().slice(0,19)}),console.log(`Projet ${t} supprim\xE9 du dossier ${i.f_id}`)}}catch(e){console.error("Erreur lors de la suppression compl\xE8te du projet :",e)}})}getFoldersCollection(){return l(this.firestore,"projects")}getFolderDocRefByPId(t){return f(this,null,function*(){let e=a(this.getFoldersCollection(),n("f_id","==",t)),r=(yield g(e)).docs[0];return r?S(this.getFoldersCollection(),r.id):null})}getFoldersForUser(t){let e=l(this.firestore,"folders"),o=a(e,n("userid","==",t));return p(o,{idField:"docId"})}getFoldersByPid(t){let e=l(this.firestore,"folders"),o=a(e,n("projects","array-contains",t));return p(o,{idField:"docId"})}addToFolder(t,e){return f(this,null,function*(){if(!t||!e)return null;console.log("Folder id :",t,"Project id :",e);try{let o=l(this.firestore,"folders"),r=a(o,n("f_id","==",t)),s=yield g(r);if(s.empty)return console.log("Folder not found"),null;{let d=s.docs[0],c=d.data().projects||[];if(c.includes(e))return console.log("Project id d\xE9j\xE0 existant dans le dossier"),c;let u=[...c,e];return yield j(d.ref,{projects:u,updatedAt:new Date().toISOString().slice(0,19)}),u}}catch(o){return console.error("Erreur lors de l'ajout au dossier :",o),null}})}removeFromFolder(t,e){return f(this,null,function*(){if(!t||!e)return null;try{let o=l(this.firestore,"folders"),r=a(o,n("f_id","==",t)),s=yield g(r);if(s.empty)return console.log("Folder not found"),null;let d=s.docs[0],c=d.data().projects||[];if(!c.includes(e))return console.log("Project id non trouv\xE9 dans le dossier"),c;let u=c.filter(I=>I!==e);return yield j(d.ref,{projects:u,updatedAt:new Date().toISOString().slice(0,19)}),u}catch(o){return console.error("Erreur lors de la suppression du projet du dossier :",o),null}})}countProjects(t){let e=l(this.firestore,"projects"),o=a(e,n("ownerId","==",t));return P(h(o).then(r=>r.data().count))}countProgressProjects(t){let e=l(this.firestore,"projects"),o=a(e,n("ownerId","==",t)&&n("status","==","En cours"));return P(h(o).then(r=>r.data().count))}countProjectsDone(t){let e=l(this.firestore,"projects"),o=a(e,n("ownerId","==",t)&&n("status","==","termin\xE9"));return P(h(o).then(r=>r.data().count))}};m.\u0275fac=function(e){return new(e||m)(O(x))},m.\u0275prov=B({token:m,factory:m.\u0275fac,providedIn:"root"});let D=m;return D})();export{L as a};
